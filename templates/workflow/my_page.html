{% extends "base.html" %}
{% block title %}ë§ˆì´í˜ì´ì§€{% endblock %}
{% block page_title %}ë§ˆì´í˜ì´ì§€{% endblock %}
{% block page_actions %}
<div style="display:flex;gap:8px">
  <button class="pn-btn ghost">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
  <button class="pn-btn">í”„ë¡œí•„ ìˆ˜ì •</button>
</div>
{% endblock %}
{% block content %}
<section class="pn-card" style="max-width:960px;margin-bottom:12px">
  <div class="pn-card" style="background:#f8fafc;display:flex;align-items:center;gap:14px;margin-bottom:12px">
    <div style="width:58px;height:58px;border-radius:50%;background:#dbe8ff;display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ‘¤</div>
    <div>
      <div style="font-weight:700">{{ profile.email }}</div>
      <div class="pn-sub">{{ profile.name }} Â· {{ profile.role }}</div>
    </div>
  </div>

  <div class="pn-grid" style="grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label class="pn-label">ì´ë¦„</label>
      <input class="pn-input" value="{{ profile.name }}" readonly />
    </div>
    <div>
      <label class="pn-label">ì†Œì†ê¸°ê´€</label>
      <input class="pn-input" value="{{ profile.organization }}" readonly />
    </div>
    <div style="grid-column:1 / -1">
      <label class="pn-label">ì „ê³µ/ë¶„ì•¼/ë¶€ì„œëª…</label>
      <input class="pn-input" value="{{ profile.major }}" readonly />
    </div>
  </div>
</section>

<section class="pn-card" style="max-width:960px">
  <h3 style="margin-top:0">ì „ìì„œëª… ë“±ë¡í•˜ê¸°(í•„ìˆ˜)</h3>
  <div id="signatureDropzone" style="height:260px;border:2px dashed #b7c6dd;border-radius:12px;background:#eef1f6;display:flex;align-items:center;justify-content:center;padding:12px;text-align:center;cursor:pointer;overflow:hidden">
    {% if profile.signature %}
      <img id="signaturePreview" src="{{ profile.signature }}" alt="ì „ìì„œëª…" style="max-width:100%;max-height:100%;object-fit:contain" />
    {% else %}
      <div id="signaturePlaceholder" style="color:#4b5563;font-size:18px;line-height:1.5">
        ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”<br />
        <small style="font-size:13px;color:#6b7280">ë˜ëŠ” í´ë¦­í•´ì„œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</small>
      </div>
      <img id="signaturePreview" alt="ì „ìì„œëª…" style="max-width:100%;max-height:100%;object-fit:contain;display:none" />
    {% endif %}
  </div>
  <input id="signatureFileInput" type="file" accept="image/*" style="display:none" />
  <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
    <button id="clearSignature" class="pn-btn ghost" type="button">ì´ˆê¸°í™”</button>
    <button id="saveSignature" class="pn-btn" type="button">ì„œëª… ì €ì¥</button>
  </div>
  <div id="signatureToast" class="pn-toast"></div>
</section>

<script>
  const dropzone = document.getElementById('signatureDropzone');
  const input = document.getElementById('signatureFileInput');
  const preview = document.getElementById('signaturePreview');
  const placeholder = document.getElementById('signaturePlaceholder');
  const toast = document.getElementById('signatureToast');
  let selectedImage = preview.getAttribute('src') || '';

  function showImage(dataUrl){
    selectedImage = dataUrl;
    preview.src = dataUrl;
    preview.style.display = 'block';
    if (placeholder) placeholder.style.display = 'none';
  }

  function showPlaceholder(){
    selectedImage = '';
    preview.removeAttribute('src');
    preview.style.display = 'none';
    if (placeholder) placeholder.style.display = 'block';
  }

  function readFile(file){
    if (!file || !file.type.startsWith('image/')) {
      toast.textContent = 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      return;
    }
    const reader = new FileReader();
    reader.onload = () => showImage(reader.result);
    reader.readAsDataURL(file);
  }

  dropzone.addEventListener('click', () => input.click());
  input.addEventListener('change', (e) => readFile(e.target.files[0]));

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = '#2463eb';
  });
  dropzone.addEventListener('dragleave', () => {
    dropzone.style.borderColor = '#b7c6dd';
  });
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = '#b7c6dd';
    readFile(e.dataTransfer.files[0]);
  });

  document.getElementById('clearSignature').addEventListener('click', () => {
    showPlaceholder();
    input.value = '';
    toast.textContent = 'ì„œëª… ì´ë¯¸ì§€ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.';
  });

  document.getElementById('saveSignature').addEventListener('click', async () => {
    if (!selectedImage) {
      toast.textContent = 'ì €ì¥í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }
    const formData = new FormData();
    formData.append('signature_data_url', selectedImage);
    const response = await fetch('/frontend/my-page/signature', {
      method: 'POST',
      headers: {'X-CSRFToken': getCsrfToken()},
      body: formData,
      credentials: 'same-origin'
    });
    const body = await response.json();
    toast.textContent = body.message || 'ì €ì¥ ì™„ë£Œ';
  });
</script>
{% endblock %}
