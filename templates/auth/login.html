<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>로그인 · ProjectNote</title>
  <style>
    body { margin:0; font-family:Pretendard,Inter,Arial,sans-serif; background:#f2f4f8; color:#1f2937; }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:100%; max-width:420px; background:#fff; border:1px solid #dbe2ed; border-radius:14px; padding:22px; box-shadow:0 8px 20px rgba(15,23,42,.06); position:relative; }
    h1 { margin:0 0 8px; font-size:30px; }
    h2 { margin:18px 0 8px; font-size:20px; }
    .sub { margin:0 0 14px; color:#7d8aa0; font-size:13px; }
    .label { font-size:12px; color:#64748b; font-weight:650; display:block; margin:0 0 4px; }
    .input, .select { width:95%; border:1px solid #dbe2ed; border-radius:8px; padding:11px; margin-bottom:12px; }
    .btn { width:100%; border:none; background:#2463eb; color:#fff; border-radius:9px; padding:11px; font-weight:700; cursor:pointer; }
    .err { margin:0 0 10px; color:#dc2626; font-size:13px; }
    .helper { margin-top:12px; color:#64748b; font-size:12px; }
    .signup-link {
      position:absolute; top:14px; right:16px; font-size:12px; color:#2463eb; text-decoration:none;
      border:1px solid #c7d7ff; border-radius:999px; padding:4px 8px; background:#f6f9ff;
    }
    .signup-link:hover { background:#eaf1ff; }
    code { background:#eef2ff; padding:2px 5px; border-radius:4px; }
    hr { border:none; border-top:1px solid #e2e8f0; margin:18px 0; }
    .hide { display:none; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <a class="signup-link" href="/signup">회원가입</a>
      <h1>로그인</h1>
      <p class="sub">로그인 후 워크플로우 화면에 접근할 수 있습니다.</p>
      {% if error %}<p class="err">{{ error }}</p>{% endif %}
      <form method="post" action="/login">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ next }}" />
        <label class="label">아이디</label>
        <input class="input" name="username" placeholder="admin" required />
        <label class="label">비밀번호</label>
        <input class="input" type="password" name="password" placeholder="admin1234" required />
        <button class="btn" type="submit">로그인</button>
      </form>

      <hr />

      <h2>회원가입</h2>
      <p class="sub">최초 가입 시 관리자 선택 가능. 관리자는 팀을 생성하고 코드가 발급됩니다.</p>
      <form id="signupForm">
        {% csrf_token %}
        <label class="label">아이디</label>
        <input class="input" name="username" required />
        <label class="label">표시 이름</label>
        <input class="input" name="display_name" required />
        <label class="label">이메일</label>
        <input class="input" type="email" name="email" required />
        <label class="label">비밀번호</label>
        <input class="input" type="password" name="password" required />

        <label class="label">가입 유형</label>
        <select class="select" name="role" id="signupRole">
          <option value="member">일반</option>
          <option value="admin">관리자</option>
        </select>

        <div id="adminTeamFields" class="hide">
          <label class="label">팀 이름 (관리자 필수)</label>
          <input class="input" name="admin_team_name" />
          <label class="label">팀 설명</label>
          <input class="input" name="team_description" />
        </div>

        <div id="memberTeamFields">
          <label class="label">팀 이름 (선택)</label>
          <input class="input" name="member_team_name" />
          <label class="label">팀 코드 (선택, 6자리)</label>
          <input class="input" name="team_code" maxlength="6" />
        </div>

        <button class="btn" type="submit">회원가입</button>
      </form>
      <p id="signupMessage" class="helper"></p>
      <div class="helper">데모 계정: <code>admin</code> / <code>admin1234</code></div>
    </section>
  </main>

  <script>
    const roleSelect = document.getElementById('signupRole');
    const adminFields = document.getElementById('adminTeamFields');
    const memberFields = document.getElementById('memberTeamFields');
    const message = document.getElementById('signupMessage');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    function updateRoleFields() {
      const isAdmin = roleSelect.value === 'admin';
      adminFields.classList.toggle('hide', !isAdmin);
      memberFields.classList.toggle('hide', isAdmin);
    }

    roleSelect.addEventListener('change', updateRoleFields);
    updateRoleFields();

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const role = formData.get('role');
      if (role === 'admin') {
        formData.set('team_name', formData.get('admin_team_name') || '');
      } else {
        formData.set('team_name', formData.get('member_team_name') || '');
      }
      formData.delete('admin_team_name');
      formData.delete('member_team_name');

      const res = await fetch('/api/v1/auth/signup', {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        credentials: 'same-origin',
        body: formData,
      });
      const body = await res.json();
      if (!res.ok) {
        message.textContent = body.detail || '회원가입 실패';
        return;
      }
      message.textContent = `회원가입 완료: ${body.username} (${body.role}) / 팀: ${body.team} / 코드: ${body.join_code}`;
      e.target.reset();
      updateRoleFields();
    });
  </script>
</body>
</html>
